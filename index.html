<div id="chatbot-container">
    <div id="chatbot-header">
        <img src="{% static 'app/images/gif/bot.gif' %}" alt="Chatbot" style="max-height: 400px; max-width: 400px;">
        <div id="chatbot-header-info">
            <div id="chatbot-name">Trợ lý English4All</div>
            <div id="chatbot-description">Hỗ trợ, học tập</div>
        </div>
        <div id="header-icons">
            <i class="fa fa-expand"></i>
            <span id="close-button">×</span>
        </div>

    </div>
    <div id="chatbot-messages">
        <!-- Messages will be appended here -->
    </div>
    <form method="POST" id="chat-form" class="flex w-full">
        <div id="chatbot-input-area">
            <input type="text" id="user-input" placeholder="Type your message...">
            <button id="send-button"><i class="fa fa-paper-plane"></i></button>
        </div>
    </form>
    <div id="chatbot-footer">Powered by Google</div>
</div>

<button id="chatbot-icon">
    <img src="{% static 'app/images/gif/bot.gif' %}" alt="Chatbot" style="max-height: 90px; max-width: 90px;">
</button>
<div id="chatbot-preview-question">
</div>
<style>
    /* General Styles */
    body {
        font-family: sans-serif;
        margin: 0;
        padding: 0;
    }

    /* Chatbot Container */
    #chatbot-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 350px;
        height: 500px;
        background-color: #1E293B;
        /* Dark background */
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        display: none;
        /* Hidden by default */
        flex-direction: column;
        overflow: hidden;
        color: #CBD5E0;
        /* Light text color */
        z-index: 1000;
    }

    #chatbot-container.active {
        display: flex;
    }

    /* Chatbot Header */
    #chatbot-header {
        background-color: #334155;
        padding: 15px;
        display: flex;
        align-items: center;
        justify-content: flex-start;
    }

    #chatbot-header img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-right: 10px;
    }

    #chatbot-header-info {
        flex-grow: 1;
        text-align: left;
    }

    #chatbot-name {
        font-weight: bold;
        font-size: 1.1em;
        color: #fff;
    }

    #chatbot-description {
        font-size: 0.9em;
        color: #94A3B8;
    }

    #header-icons {
        display: flex;
        align-items: center;
    }

    #header-icons i,
    #close-button {
        margin-left: 10px;
        cursor: pointer;
        font-size: 1.2em;
    }

    #header-icons i {
        color: #94A3B8;
    }

    #close-button {
        color: #CBD5E0;
    }


    /* Chatbot Messages */
    #chatbot-messages {
        flex-grow: 1;
        padding: 15px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
    }

    .user-message,
    .bot-message {
        padding: 10px 15px;
        margin-bottom: 10px;
        border-radius: 20px;
        max-width: 80%;
        word-wrap: break-word;
    }

    .user-message {
        background-color: #475569;
        /* Darker blue for user */
        align-self: flex-end;
        text-align: right;
    }

    .bot-message {
        background-color: #334155;
        /* Light blue for bot */
        align-self: flex-start;
        text-align: left;
    }

    /* Chatbot Input Area */
    #chatbot-input-area {
        padding: 10px;
        display: flex;
        align-items: center;
        background-color: #334155;
    }

    #user-input {
        flex-grow: 1;
        padding: 10px 15px;
        border: none;
        border-radius: 25px;
        background-color: #475569;
        color: #CBD5E0;
        outline: none;
        font-size: 1em;
        margin-right: 10px;
    }

    #send-button {
        background-color: #007bff;
        /* Blue send button */
        color: #fff;
        border: none;
        padding: 10px 15px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 1.2em;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    #send-button i {
        margin: 0;
    }

    /* Chatbot Footer */
    #chatbot-footer {
        padding: 10px;
        text-align: center;
        font-size: 0.8em;
        color: #94A3B8;
    }

    /* Chatbot Icon */
    #chatbot-icon {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: #1E293B;
        /* Dark background for icon */
        color: #fff;
        border: none;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        z-index: 999;
    }

    #chatbot-icon img {
        max-width: 40px;
        max-height: 40px;
        border-radius: 50%;
    }

    /* Message Animation */
    @keyframes zoomInContainer {
        0% {
            transform: scale(0.8);
            opacity: 0;
        }

        /* Start smaller and transparent */
        100% {
            transform: scale(1);
            opacity: 1;
        }

        /* End at normal size and fully visible */
    }

    /* Apply the zoom-in animation to the chatbot container */
    #chatbot-container.active {
        display: flex;
        /* Ensure it's displayed */
        animation: zoomInContainer 0.3s ease-out forwards;
        /* Shorter duration for the container */
    }

    @keyframes zoomInIcon {
        0% {
            transform: scale(1);
        }

        50% {
            transform: scale(1.2);
        }

        /* Zoom in more significantly */
        100% {
            transform: scale(1);
        }
    }

    /* Apply the zoom animation to the chatbot icon */
    #chatbot-icon.zoom {
        animation: zoomInIcon 2s ease-in-out infinite;
        /* Longer duration for a more noticeable effect */
    }

    #chatbot-icon:hover {
        animation: none;
        /* Stop animation on hover */
    }

    #chatbot-preview-question {
        position: fixed;
        bottom: 80px;
        right: 80px;
        background-color: #334155;
        color: #CBD5E0;
        border-radius: 10px;
        padding: 10px;
        max-width: 200px;
        font-size: 0.9em;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        z-index: 998;
        opacity: 1;
        transition: opacity 0.3s ease;
    }

    #chatbot-preview-question.hidden {
        opacity: 0;
        pointer-events: none;
    }

    #chatbot-preview-question {
        /* ... các kiểu dáng khác ... */
        opacity: 0;
        transition: opacity 1s ease;
    }

    #chatbot-preview-question.fade-in {
        opacity: 1;
    }

    #chatbot-preview-question.hidden {
        opacity: 0;
        pointer-events: none;
    }

    .bot-message,
    .user-message {
        /* ... các kiểu dáng khác ... */
        opacity: 1;
        transition: opacity 1s ease;
    }

    .bot-message.fade-in,
    .user-message.fade-in {
        opacity: 1;
    }
    .typing-indicator {
        display: flex;
        align-items: center;
    }

    .typing-indicator span {
        width: 8px;
        height: 8px;
        background-color: #CBD5E0;
        border-radius: 50%;
        margin: 0 4px;
        animation: typing 1.4s infinite ease-in-out;
    }

    .typing-indicator span:nth-child(2) {
        animation-delay: 0.2s;
    }

    .typing-indicator span:nth-child(3) {
        animation-delay: 0.4s;
    }

    @keyframes typing {
        0% {
            transform: translateY(0);
        }
        28% {
            transform: translateY(-5px);
        }
        44% {
            transform: translateY(0);
        }
    }
</style>
<script>
    const chatbotIcon = document.getElementById('chatbot-icon');
    const chatbotContainer = document.getElementById('chatbot-container');
    const chatbotMessages = document.getElementById('chatbot-messages');
    const userInput = document.getElementById('user-input');
    const sendButton = document.getElementById('send-button');
    const closeButton = document.getElementById('close-button');

    // Load conversation history from localStorage on page load
    window.addEventListener('load', () => {
        chatbotIcon.classList.add('zoom');
    });

    chatbotIcon.addEventListener('click', () => {
        chatbotContainer.classList.add('active');
        chatbotIcon.classList.remove('zoom');

        if (!chatbotMessages.hasChildNodes()) {
            addBotMessage("Xin chào! Mình là Trợ giảng cánh cụt. Mình có thể giúp gì cho bạn?");
        }
        userInput.focus();
    });

    closeButton.addEventListener('click', () => {
        chatbotContainer.classList.remove('active');
        chatbotIcon.classList.add('zoom');
    });

    // Handle send button click
    sendButton.addEventListener('click', (e) => {
        e.preventDefault();
        sendMessage();
    });

    // Handle enter key
    userInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            sendMessage();
        }
    });

    function sendMessage() {
        const message = userInput.value.trim();
        if (message) {
            addUserMessage(message);
            userInput.value = '';

            // Thêm animation "typing"
            addTypingIndicator();

            fetch('/chatbot/response/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    'message': message
                })
            })
                .then(response => response.json())
                .then(data => {
                    // Xóa animation "typing"
                    removeTypingIndicator();

                    if (data.response) {
                        addBotMessage(data.response);
                    } else if (data.error) {
                        console.error('Server error:', data.error);
                        addBotMessage("Xin lỗi, đã có lỗi xảy ra: " + data.error);
                    }
                })
                .catch(error => {
                    // Xóa animation "typing" khi có lỗi kết nối
                    removeTypingIndicator();

                    console.error('Network error:', error);
                    addBotMessage("Xin lỗi, đã có lỗi kết nối. Vui lòng thử lại sau.");
                });
        }
    }

    function addUserMessage(message) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('user-message');
        messageDiv.textContent = message;
        chatbotMessages.appendChild(messageDiv);
        scrollToBottom();
    }

    function addBotMessage(message) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('bot-message');
        messageDiv.textContent = message;
        chatbotMessages.appendChild(messageDiv);
        scrollToBottom();
        requestAnimationFrame(() => {
            setTimeout(() => {
                messageDiv.classList.remove('fade-in');
            }, 7000);
        });
    }

    function scrollToBottom() {
        chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
    }

    const chatbotPreviewQuestion = document.getElementById('chatbot-preview-question');
    const questions = [
        "Hôm nay bạn muốn học gì?",
        "Bạn có câu hỏi nào không?",
        "Bạn đã làm bài tập hôm nay chưa?",
        "Bạn có người yêu chưa :))",
        "Nếu bạn chưa có người yêu thì lêu lêu đồ FA :))",
        "Cơm nước gì chưa người đẹp",
        "Ngại học quá! Làm ván game cho đỡ chán",
        "3h anh còn chưa ngủ, học hết từ vựng biết bao nhiêu là cho đủ",
        "Bạn có cần giúp đỡ không?",
        "Bạn thích học TOEIC hay IELTS",
        "What the f*k are you doing?"
    ];
    let currentQuestionIndex = 0;

    function showNextQuestion() {
        if (currentQuestionIndex < questions.length) {
            chatbotPreviewQuestion.textContent = questions[currentQuestionIndex];
            currentQuestionIndex++;
            setTimeout(showNextQuestion, 5000);
        }
    }

    // Bắt đầu hiển thị câu hỏi khi trang tải
    window.addEventListener('load', () => {
        showNextQuestion();
    });

    chatbotIcon.addEventListener('click', () => {
        chatbotContainer.classList.add('active');
        chatbotIcon.classList.remove('zoom');
        chatbotPreviewQuestion.classList.add('hidden');
    });

    closeButton.addEventListener('click', () => {
        chatbotContainer.classList.remove('active');
        chatbotIcon.classList.add('zoom');
        chatbotPreviewQuestion.classList.remove('hidden');
    });

    function showRandomQuestion() {
        const randomIndex = Math.floor(Math.random() * questions.length);
        chatbotPreviewQuestion.textContent = questions[randomIndex];
        chatbotPreviewQuestion.classList.add('fade-in');
        setTimeout(() => {
            chatbotPreviewQuestion.classList.remove('fade-in');
        }, 3000);
        setTimeout(showRandomQuestion, 5000);
    }

    // Bắt đầu hiển thị câu hỏi ngẫu nhiên khi trang tải
    window.addEventListener('load', () => {
        showRandomQuestion();
    });

    // Thêm animation "typing"
    function addTypingIndicator() {
        const typingDiv = document.createElement('div');
        typingDiv.classList.add('bot-message', 'typing-indicator');
        typingDiv.innerHTML = '<span>.</span><span>.</span><span>.</span>';
        chatbotMessages.appendChild(typingDiv);
        scrollToBottom();
    }

    // Xóa animation "typing"
    function removeTypingIndicator() {
        const typingIndicator = document.querySelector('.typing-indicator');
        if (typingIndicator) {
            typingIndicator.remove();
        }
    }
</script>